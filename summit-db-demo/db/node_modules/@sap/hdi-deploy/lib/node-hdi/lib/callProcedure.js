/* jshint node: true */

'use strict';

//function _create_array_stream(resultSet) {
//    if (!resultSet) {
//        return null;
//    }
//    resultSet.setFetchSize(32*1024);
//    var stream = resultSet.createArrayStream();
//    stream.on('finish', function () { if (!resultSet.closed) { resultSet.close(); } });
//    return stream;
//}

exports.callHDIProcedure = function(connection, sql_stmt, sql_params, callback) {
    connection.prepare(sql_stmt, function(err, stmt) {
        if (err) {
            return callback(err);
        }

//        stmt.execute(sql_params, function(err, parameters, messages, results) {
        stmt.exec(sql_params, function(err, parameters, messages, results) {
            if (err) {
                return callback(err);
            }

            return callback(null, { RETURN_CODE: parameters.RETURN_CODE,
                                    REQUEST_ID: parameters.REQUEST_ID,
                                    MESSAGES: messages,
                                    RESULTS: (typeof results !== 'undefined') ? results : [] });
//                                    MESSAGES: _create_array_stream(messages),
//                                    RESULTS: _create_array_stream(results) });
        });
    });
};
